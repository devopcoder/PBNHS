<!DOCTYPE html>
<html>
  <head>
    <title>QR Code Attendance</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(120deg, #fdfbfb, #ebedee);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      #reader {
        width: 90%;
        max-width: 400px;
        margin-top: 10px;
      }

      #status {
        margin-top: 15px;
        font-size: 1.1em;
        color: green;
        font-weight: bold;
      }

      #switchCam {
        margin-top: 10px;
        padding: 8px 15px;
        border: none;
        border-radius: 8px;
        background-color: #4CAF50;
        color: white;
        font-size: 14px;
        cursor: pointer;
      }

      #switchCam:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“· QR Code Attendance</h1>
    <div id="reader"></div>
    <button id="switchCam">Switch Camera</button>
    <div id="status">Waiting for scan...</div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
      const scannerDiv = document.getElementById("reader");
      const status = document.getElementById("status");
      const switchCamBtn = document.getElementById("switchCam");

      let cameraFacing = "environment"; // start with back camera
      let scanner;

      function beep() {
        const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        audio.play();
      }

      async function startScanner(facingMode) {
        if (scanner) {
          await scanner.stop().catch(() => {});
        }

        scanner = new Html5Qrcode("reader");
        scanner.start(
          { facingMode: facingMode },
          {
            fps: 10,
            qrbox: 250
          },
          async (qrText) => {
            beep();
            status.textContent = "âœ… Scanned: " + qrText;

            try {
              const json = JSON.parse(qrText);
              const res = await fetch("https://script.google.com/macros/s/AKfycbwEPd1tybx4XTb_kCTo-uFdp5PmjVqEM5cCeEbqmXvnf6gcNCkdsal7Jqr-tRga3BP1/exec", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(json)
              });
              const result = await res.text();
              status.textContent = result;
            } catch (err) {
              status.textContent = "âŒ Invalid QR code.";
            }

            setTimeout(() => {
              status.textContent = "Waiting for scan...";
            }, 3000);
          }
        );
      }

      switchCamBtn.onclick = () => {
        cameraFacing = cameraFacing === "environment" ? "user" : "environment";
        startScanner(cameraFacing);
      };

      // Start scanner on load
      startScanner(cameraFacing);
    </script>
  </body>
</html>
