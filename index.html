<!DOCTYPE html>
<html>
<head>
  <title>üì∑ Attendance Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(to bottom right, #a6c1ee, #fbc2eb);
      margin: 0;
      padding: 0;
    }
    h2 { margin-top: 20px; }
    #reader {
      width: 300px;
      margin: 20px auto;
      border: 3px solid #444;
      border-radius: 10px;
    }
    .status-box {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .scan-count {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    .pause {
      margin-top: 10px;
      color: #888;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>üì∑ QR Attendance Scanner</h2>

  <div id="reader"></div>

  <div class="status-box">
    <div id="studentInfo">Waiting for scan...</div>
    <div class="scan-count" id="scanCount"></div>
    <div class="pause" id="pauseMsg" style="display: none;">‚è∏Ô∏è Scanning paused for 4 seconds...</div>
  </div>

  <script>
    const reader = new Html5Qrcode("reader");
    let scanning = true;

    function showPauseMessage(show) {
      document.getElementById("pauseMsg").style.display = show ? "block" : "none";
    }

    function startScanner() {
      reader.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        (decodedText) => {
          if (!scanning) return;

          scanning = false;
          showPauseMessage(true);

          try {
            const json = JSON.parse(decodedText);
            const payload = {
              name: json.name,
              section: json.section
            };

            fetch('https://script.google.com/macros/s/AKfycbxu2D_ckD2x9X_B-K6icNKdlzrPcWiFOCTwbTPwsxLlXpW_r0etStf3bDBZF-tE9_uu/exec', {
              method: 'POST',
              body: JSON.stringify(payload)
            })
            .then(response => response.text())
            .then(data => {
              document.getElementById("studentInfo").innerHTML =
                `<strong>${payload.name}</strong><br>Section: ${payload.section}`;
              document.getElementById("scanCount").innerText = `Total Scan: ${data}`;
            })
            .catch(error => {
              document.getElementById("studentInfo").innerText = "‚ùå Scan failed.";
              console.error(error);
            });

          } catch (e) {
            document.getElementById("studentInfo").innerText = "‚ö†Ô∏è Invalid QR code";
          }

          // 4-second pause before scanning again
          setTimeout(() => {
            scanning = true;
            showPauseMessage(false);
          }, 4000);
        },
        (errorMessage) => {
          // ignore scan errors
        }
      );
    }

    startScanner();
  </script>
</body>
</html>
