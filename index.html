<script>
  const sheetURL = "https://script.google.com/macros/s/AKfycbxu2D_ckD2x9X_B-K6icNKdlzrPcWiFOCTwbTPwsxLlXpW_r0etStf3bDBZF-tE9_uu/exec";
  const beepSound = document.getElementById("beep");
  const overlay = document.getElementById("overlay");

  let scanner = new Html5Qrcode("reader");
  let isScanning = true;

  function sendToGoogleSheet(data) {
    fetch(sheetURL, {
      method: "POST",
      body: JSON.stringify(data),
    })
    .then(res => res.text())
    .then(responseText => {
      document.getElementById("status").innerText = "âœ… Attendance Logged!";
      document.getElementById("login-count").innerText = "Total Login: " + responseText;
    })
    .catch(() => {
      document.getElementById("status").innerText = "âŒ Failed to log.";
      document.getElementById("login-count").innerText = "Total Login: --";
    });
  }

  function showOverlay() {
    overlay.classList.add("show");
    setTimeout(() => {
      overlay.classList.remove("show");
    }, 1500);
  }

  function onScanSuccess(decodedText) {
    if (!isScanning) return;

    isScanning = false;
    try {
      const parsed = JSON.parse(decodedText);
      document.getElementById("status").innerText = `ğŸ“¤ Logging: ${parsed.name}`;
      sendToGoogleSheet(parsed);
      beepSound.play();
      showOverlay();
    } catch (e) {
      document.getElementById("status").innerText = "âŒ Invalid QR Code!";
    }

    scanner.pause();
    setTimeout(() => {
      document.getElementById("status").innerText = "âœ… Ready for next scan";
      scanner.resume(onScanSuccess);
      isScanning = true;
    }, 2000);
  }

  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      scanner.start(
        cameras[0].id,
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    }
  }).catch(err => {
    document.getElementById("status").innerText = "âŒ Camera Error!";
  });
</script>
